---
title: "demonstrate_bias_151507_DLPFC_layers"
output: html_document
date: '2023-01-23'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}

library(spatialLIBD)
library(nnSVG)

#https://github.com/LieberInstitute/spatialLIBD
spe <- fetch_data(type = "spe")
spe_151507 <- spe[, spe$sample_id == "151507"]

#5 spots have NA layer label
#sum(is.na(unfactor(colData(spe_151507)$spatialLIBD))) 

spe_151507 <- spe_151507[, !is.na(unfactor(colData(spe_151507)$spatialLIBD))]

#repeat same process for all layers
layer_list <- c("L1", "L2", "L3", "L4", "L5", "L6", "WM")
n_umis <- 80

for (layer in layer_list) {
  spe_layer <- spe_151507[, colData(spe_151507)$spatialLIBD == layer]

  # filter out genes with extremely low expression
  # using simple threshold on total UMI counts summed across all spots
  ix_low_genes <- rowSums(counts(spe_layer)) < n_umis
  spe_layer <- spe_layer[!ix_low_genes, ]
  
  # set seed for reproducibility
  set.seed(123)
  
  #run nnSVG
  spe_layer <- nnSVG(spe_layer)
  # show results
  rowData(spe_layer)
  
  # Save an object to a file
  file_name <- paste("spe_151507_", layer, "_DLPFC_nnSVG.rds", sep = "")
  saveRDS(spe_layer, file = file_name)
}

```


```{r}

library(SpatialExperiment)
library(here)
library(dplyr)
library(tidyr)
library(readr)
library(ggplot2)
library(ggrepel)
library(viridis)
library(ggpubr)

layer <- "WM"

file_name <- paste("mean_var_project/spe_151507_", layer, "_DLPFC_nnSVG.rds", sep = "")
spe <- readRDS(file = file_name)

spe_df <- rowData(spe)

df_nnSVG <- 
  as.data.frame(spe_df)

df_effect <- 
  as.data.frame(df_nnSVG) %>% 
  mutate(l = 1 / phi) %>% 
  filter(rank <= 1000)

# variance vs. mean
var <- ggplot(df_effect, 
       aes(x = mean, y = var, color = LR_stat)) + 
  geom_point(size = 0.75) + 
  scale_color_viridis(trans = "log10") +
  scale_color_gradient(low = "blue", high = "red") +
  labs(x = "mean logcounts", 
       y = "variance", 
       color = "LR statistic") + 
  ggtitle("nnSVG: human DLPFC") + 
  theme_bw()

# spatial variance vs. mean
spat_var <- ggplot(df_effect, 
       aes(x = mean, y = sigma.sq, color = LR_stat)) + 
  geom_point(size = 0.75) + 
  scale_color_viridis(trans = "log10") + 
  scale_color_gradient(low = "blue", high = "red") +
  labs(x = "mean logcounts", 
       y = "spatial variance (sigma^2)", 
       color = "LR statistic") + 
  ggtitle("nnSVG: human DLPFC") + 
  theme_bw()

# nonspatial variance vs. mean
nonspat_var <- ggplot(df_effect, 
       aes(x = mean, y = tau.sq, color = LR_stat)) + 
  geom_point(size = 0.75) + 
  scale_color_viridis(trans = "log10") + 
  scale_color_gradient(low = "blue", high = "red") +
  labs(x = "mean logcounts", 
       y = "nonspatial variance (tau^2)", 
       color = "LR statistic") + 
  ggtitle("nnSVG: human DLPFC") + 
  theme_bw()

# proportion spatial variance vs. mean
prop <- ggplot(df_effect, 
       aes(x = mean, y = prop_sv, color = LR_stat)) + 
  geom_point(size = 0.75) + 
  scale_color_viridis(trans = "log10") + 
  scale_color_gradient(low = "blue", high = "red") +
  labs(x = "mean logcounts", 
       y = "proportion spatial variance", 
       color = "LR statistic") + 
  ggtitle("nnSVG: human DLPFC") + 
  theme_bw()

figure <- ggarrange(var, spat_var, nonspat_var, prop,
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2,
          common.legend = TRUE, legend = "right")

title_text <- paste("DLPFC 151507 ", layer, sep = "")
annotate_figure(figure, 
                top = text_grob(title_text, color = "black", face = "bold", size = 14))
```

